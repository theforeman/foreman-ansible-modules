---
- name: create test hostgroups
  hostgroup:
    username: admin
    password: changeme
    server_url: http://127.0.0.1:{{ foreman_port }}/
    name: "{{ item.name }}"
    parent: "{{ item.parent | default(omit) }}"
    organizations:
      - Default Organization
    locations:
      - Default Location
  with_items: "{{ foreman_groups }}"

- name: create test hosts
  host:
    username: admin
    password: changeme
    server_url: http://127.0.0.1:{{ foreman_port }}/
    name: "{{ item.key }}"
    hostgroup: "{{ item.value }}"
    build: false
    organization: Default Organization
    location: Default Location
    managed: false
    parameters:
      - name: testparam1
        value: testvalue1
      - name: testparam2
        value: testvalue2
  with_dict: "{{ foreman_hosts }}"

- name: submit facts for hosts
  uri:
    url: http://127.0.0.1:{{ foreman_port }}/api/hosts/facts
    url_username: admin
    url_password: changeme
    validate_certs: false
    method: POST
    body:
      name: "{{ item.key }}"
      facts:
        fqdn: "{{ item.key }}"
        domain: example.com
        famtesthost: true
        operatingsystem: CentOS
        operatingsystemrelease: "7.7"
    force_basic_auth: true
    status_code: 201
    body_format: json
  with_dict: "{{ foreman_hosts }}"
  ignore_errors: true
