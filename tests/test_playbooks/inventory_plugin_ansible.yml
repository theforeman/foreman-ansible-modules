---
- hosts: container
  vars:
    foreman_groups:
      - name: group_a
      - name: group_b
      - name: group_c
        label: group_b/group_c
        parent: group_b
    foreman_hosts:
      testhost1.example.com: group_a
      testhost2.example.com: group_b/group_c
    foreman_container: "quay.io/evgeni/foreman-ansible"
    foreman_version: "2.3-ansible"
    foreman_host: "foremanansible"
    foreman_port: "3001"
    postgres_version: "12"
    postgres_host: "postgresansible"
    postgres_port: 5433
  collections:
    - community.docker
    - theforeman.foreman
  tasks:
    - name: test inventory
      include_tasks: tasks/inventory_plugin.yml

    - name: Find cache file
      find:
        paths: "{{ lookup('env', 'ANSIBLE_INVENTORY_CACHE_CONNECTION') }}"
        patterns: 'ansible_inventory_*'
      register: cache_files

    - name: Assert exactly one cache file was found
      assert:
        that: cache_files['files'] | length == 1

    - name: Fetch cache file
      slurp:
        src: "{{ cache_files['files'][0]['path'] }}"
      register: cache_slurp

    - name: Assert cache content
      assert:
        that:
          - "{{ cache_content | selectattr('name', 'equalto', 'testhost1.example.com') | map(attribute='name') | list }} == ['testhost1.example.com']"
          - "{{ cache_content | selectattr('name', 'equalto', 'testhost1.example.com') | map(attribute='facts', default=[]) | list | first }} != []"
      vars:
        cache_content: "{{ (cache_slurp['content'] | b64decode | from_json).get('http://localhost:3001//ansible/api/v2/ansible_inventories/schedule') }}"
